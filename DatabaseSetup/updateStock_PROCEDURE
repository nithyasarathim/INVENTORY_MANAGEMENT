DELIMITER //

CREATE PROCEDURE UpdateStockLevel(
    IN p_stock_id INT,
    IN p_stock_count INT,
    IN p_option CHAR
)
BEGIN
    DECLARE current_stock INT;
    DECLARE new_stock_level INT;

    SELECT stock_level INTO current_stock
    FROM STOCK_DATA
    WHERE stock_id = p_stock_id;

    IF p_option = 'A' THEN
        SET new_stock_level = current_stock + p_stock_count;
    ELSEIF p_option = 'R' THEN
        SET new_stock_level = current_stock - p_stock_count;
    END IF;

    UPDATE STOCK_DATA
    SET stock_level = new_stock_level
    WHERE stock_id = p_stock_id;

    INSERT INTO TRANSACTION_LOG (product_id, inventory_id, transaction_type, quantity)
    SELECT product_id, inventory_id, 
           CASE WHEN p_option = 'A' THEN 'ADD' ELSE 'REMOVE' END, 
           p_stock_count
    FROM STOCK_DATA
    WHERE stock_id = p_stock_id;
END //

DELIMITER ;
